
<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <title>Mappa Meteo - Cosenza Vaiolise</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <style>
    body, html { margin: 0; padding: 0; font-family: Arial, sans-serif; height: 100%; }
    #map { height: 100vh; width: 100%; }
    .temperature-label {
      background-color: rgba(255,255,255,0.7);
      border-radius: 50%;
      border: 2px solid #333;
      width: 30px;
      height: 30px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
      font-size: 12px;
      color: black;
      text-align: center;
    }
    .popup-title { font-size: 18px; font-weight: bold; }
    .popup-subtitle { font-size: 12px; color: #666; margin-bottom: 5px; }
    .popup-data { margin: 5px 0; }
    .popup-button {
      margin: 5px 3px;
      padding: 5px 8px;
      background: #007bff;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
    }
    .webcam-preview {
      width: 100%;
      max-height: 120px;
      object-fit: cover;
      margin-top: 8px;
      border-radius: 5px;
    }
    .graph-container { display: none; margin-top: 10px; }
  </style>
</head>
<body>

<div id="map"></div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
const apiKey = "03d402e1e8844ac49402e1e8844ac419";
const stationId = "ICOSEN11";
const stationName = "Cosenza Vaiolise";
const stationLat = 39.32;
const stationLon = 16.26;
const quota = "208 m";
const provincia = "Cosenza";
const regione = "Calabria";
const webcamUrl = ""; // Lascia vuoto per ora
const paginaStazioneUrl = ""; // Lascia vuoto per ora

var map = L.map('map').setView([stationLat, stationLon], 12);

L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
  maxZoom: 18,
  attribution: '&copy; OpenStreetMap contributors'
}).addTo(map);

function getColor(temp) {
  if (temp <= 0) return '#0033cc';
  if (temp <= 5) return '#66ccff';
  if (temp <= 10) return '#00ffcc';
  if (temp <= 15) return '#00cc66';
  if (temp <= 20) return '#ccff33';
  if (temp <= 25) return '#ffff00';
  if (temp <= 28) return '#ffcc00';
  if (temp <= 32) return '#ff9900';
  if (temp <= 35) return '#ff6600';
  if (temp <= 38) return '#ff3300';
  if (temp <= 40) return '#cc0000';
  return '#990000';
}

fetch(`https://api.weather.com/v2/pws/observations/current?stationId=${stationId}&format=json&units=m&apiKey=${apiKey}`)
  .then(response => response.json())
  .then(data => {
    const obs = data.observations[0];

    const temperatura = obs.metric.temp;
    const tempMax = obs.metric.tempHigh24Hour;
    const tempMin = obs.metric.tempLow24Hour;
    const umidita = obs.humidity;
    const vento = obs.windSpeed;
    const raffica = obs.windGust;
    const pioggia = obs.metric.precipTotal;

    var tempIcon = L.divIcon({
      className: 'temperature-label',
      html: `${temperatura}°`,
      iconSize: [30, 30],
      iconAnchor: [15, 15]
    });

    var marker = L.marker([stationLat, stationLon], {icon: tempIcon}).addTo(map);
    marker.getElement().style.backgroundColor = getColor(temperatura);

    var popupContent = `
      <div class="popup-title">${stationName}</div>
      <div class="popup-subtitle">${provincia} - ${regione}</div>
      <div class="popup-data">Quota: ${quota}</div>
      <div class="popup-data">Temp: ${temperatura}°C</div>
      <div class="popup-data">Max: ${tempMax}°C / Min: ${tempMin}°C</div>
      <div class="popup-data">Umidità: ${umidita}%</div>
      <div class="popup-data">Vento: ${vento} km/h | Raffica: ${raffica} km/h</div>
      <div class="popup-data">Pioggia: ${pioggia} mm</div>
      ${webcamUrl ? `<img class="webcam-preview" src="${webcamUrl}" alt="Webcam">` : '<i>Webcam non disponibile</i>'}
      <br>
      <button class="popup-button" onclick="openGraph()">Grafico</button>
      <button class="popup-button" onclick="location.href='${paginaStazioneUrl}'">Vai alla stazione</button>
      <div id="graph-container" class="graph-container">
        <canvas id="graphCanvas" width="250" height="150"></canvas>
        <div style="margin-top:5px;">
          <button class="popup-button" onclick="plotGraph('temp')">Temp</button>
          <button class="popup-button" onclick="plotGraph('umid')">Umid</button>
          <button class="popup-button" onclick="plotGraph('vento')">Vento</button>
          <button class="popup-button" onclick="plotGraph('pioggia')">Pioggia</button>
        </div>
      </div>
    `;

    marker.bindPopup(popupContent);
  })
  .catch(error => {
    console.error('Errore caricamento dati:', error);
  });

function openGraph() {
  document.getElementById('graph-container').style.display = "block";
  plotGraph('temp');
}

function plotGraph(tipo) {
  var ctx = document.getElementById('graphCanvas').getContext('2d');
  let label = "", dati = [], colore = "";

  if (tipo == 'temp') {
    label = 'Temperatura (°C)';
    dati = [12, 14, 18, 20, 21];
    colore = 'red';
  } else if (tipo == 'umid') {
    label = 'Umidità (%)';
    dati = [70, 75, 80, 77, 73];
    colore = 'blue';
  } else if (tipo == 'vento') {
    label = 'Vento (km/h)';
    dati = [3, 5, 6, 4, 5];
    colore = 'green';
  } else if (tipo == 'pioggia') {
    label = 'Pioggia (mm)';
    dati = [0, 0.2, 0, 0, 0.5];
    colore = 'navy';
  }

  new Chart(ctx, {
    type: 'line',
    data: {
      labels: ['00h', '06h', '12h', '18h', '24h'],
      datasets: [{
        label: label,
        data: dati,
        borderColor: colore,
        backgroundColor: colore + '20',
        fill: true
      }]
    },
    options: { responsive: true, maintainAspectRatio: false }
  });
}
</script>

</body>
</html>
