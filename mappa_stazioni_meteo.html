
<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <title>Mappa Stazioni Meteo - Calabria</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <style>
        body { font-family: Arial, sans-serif; background: #f8f9fa; margin: 0; padding: 0;}
        #map { height: 600px; width: 100%; }
        .sidebar {
            position: absolute;
            top: 20px;
            left: 10px;
            background: rgba(255, 255, 255, 0.9);
            padding: 8px;
            border-radius: 8px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.3);
            z-index: 1000;
            width: 150px;
        }
        .sidebar button {
            margin-bottom: 5px;
            font-size: 14px;
            padding: 5px;
            width: 100%;
        }
        .temperature-label {
            background-color: white;
            border: 1px solid gray;
            border-radius: 8px;
            padding: 2px 5px;
            font-size: 12px;
            font-weight: bold;
            text-align: center;
        }
        .station-table {
            margin: 20px auto;
            max-width: 95%;
        }
        .modal-body canvas {
            width: 100% !important;
            height: 400px !important;
        }
        @media (max-width: 768px) {
            .sidebar {
                width: 130px;
                top: 10px;
                left: 10px;
                padding: 6px;
            }
            .sidebar button {
                font-size: 12px;
                padding: 4px;
            }
        }
    </style>
</head>
<body>

<div id="map"></div>

<div class="sidebar">
    <button class="btn btn-outline-primary btn-sm" onclick="filtra('temp_max')">Temp Max</button>
    <button class="btn btn-outline-primary btn-sm" onclick="filtra('temp_min')">Temp Min</button>
    <button class="btn btn-outline-primary btn-sm" onclick="filtra('pioggia')">Pioggia</button>
    <button class="btn btn-outline-primary btn-sm" onclick="filtra('raffica')">Raffica Max</button>
    <button class="btn btn-outline-secondary btn-sm" onclick="resetFiltri()">Reset</button>
</div>

<div class="container station-table">
    <h2 class="text-center">Stazioni Meteo Attive</h2>
    <div class="table-responsive">
        <table class="table table-striped table-bordered" id="stazioniTable">
            <thead class="table-dark">
                <tr>
                    <th>Località</th>
                    <th>Temperatura (°C)</th>
                    <th>Max (°C)</th>
                    <th>Min (°C)</th>
                    <th>Umidità (%)</th>
                    <th>Vento (km/h)</th>
                    <th>Raffica (km/h)</th>
                    <th>Pioggia (mm)</th>
                    <th>Grafici</th>
                </tr>
            </thead>
            <tbody id="stazioniBody"></tbody>
        </table>
    </div>
</div>

<!-- Modale Grafici -->
<div class="modal fade" id="graficoModal" tabindex="-1" aria-labelledby="graficoModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="graficoModalLabel">Grafici Stazione</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <canvas id="graficoStazione"></canvas>
      </div>
    </div>
  </div>
</div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
    var map = L.map('map').setView([39.3, 16.3], 9);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 18,
        attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);

    var stazioni = [
        {nome: "Amantea Spiaggia", lat: 39.13, lon: 16.07, temp: 25, temp_max: 27, temp_min: 20, umidita: 70, vento: 15, raffica: 20, pioggia: 2, webcam: "#"},
        {nome: "Celico Montescuro", lat: 39.33, lon: 16.40, temp: 18, temp_max: 20, temp_min: 16, umidita: 85, vento: 10, raffica: 18, pioggia: 5, webcam: ""},
        {nome: "Cosenza Campagnano", lat: 39.31, lon: 16.23, temp: 23, temp_max: 26, temp_min: 19, umidita: 68, vento: 8, raffica: 12, pioggia: 0, webcam: ""},
        {nome: "Mendicino Tivolille", lat: 39.28, lon: 16.20, temp: 22, temp_max: 24, temp_min: 18, umidita: 73, vento: 9, raffica: 14, pioggia: 1, webcam: "#"}
    ];

    var markers = [];

    function aggiungiMarker(stazione) {
        var marker = L.marker([stazione.lat, stazione.lon]).addTo(map);
        var popupContent = `
            <b>${stazione.nome}</b><br>
            Temperatura: ${stazione.temp} °C<br>
            Max: ${stazione.temp_max} °C / Min: ${stazione.temp_min} °C<br>
            Umidità: ${stazione.umidita}%<br>
            Vento: ${stazione.vento} km/h<br>
            Raffica: ${stazione.raffica} km/h<br>
            Pioggia: ${stazione.pioggia} mm<br>
            ${stazione.webcam ? `<a href="${stazione.webcam}" target="_blank">Webcam</a><br>` : ''}
            <button class="btn btn-sm btn-info mt-1" onclick="apriGrafico('${stazione.nome}')">Grafici</button>
        `;
        marker.bindPopup(popupContent);
        markers.push({ marker: marker, dati: stazione });
    }

    stazioni.forEach(aggiungiMarker);

    function filtra(tipo) {
        markers.forEach(m => {
            var value = m.dati[tipo];
            m.marker.bindTooltip(`${value}`, {permanent: true, direction: 'top', className: 'temperature-label'}).openTooltip();
        });
    }

    function resetFiltri() {
        markers.forEach(m => m.marker.unbindTooltip());
    }

    function caricaTabella() {
        var tbody = document.getElementById('stazioniBody');
        tbody.innerHTML = '';
        let ordinato = stazioni.slice().sort((a, b) => b.temp - a.temp);
        ordinato.forEach(stazione => {
            var riga = `
                <tr>
                    <td>${stazione.nome}</td>
                    <td>${stazione.temp}</td>
                    <td>${stazione.temp_max}</td>
                    <td>${stazione.temp_min}</td>
                    <td>${stazione.umidita}</td>
                    <td>${stazione.vento}</td>
                    <td>${stazione.raffica}</td>
                    <td>${stazione.pioggia}</td>
                    <td><button class="btn btn-sm btn-primary" onclick="apriGrafico('${stazione.nome}')">Vedi</button></td>
                </tr>
            `;
            tbody.innerHTML += riga;
        });
    }

    caricaTabella();

    function apriGrafico(nome) {
        var stazione = stazioni.find(s => s.nome === nome);
        var modal = new bootstrap.Modal(document.getElementById('graficoModal'));
        modal.show();

        var ctx = document.getElementById('graficoStazione').getContext('2d');
        if (window.myChart) {
            window.myChart.destroy();
        }
        window.myChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: Array.from({length: 24}, (_, i) => i + ":00"),
                datasets: [
                    {
                        label: 'Temperatura (°C)',
                        data: Array.from({length: 24}, () => Math.floor(Math.random() * (stazione.temp_max - stazione.temp_min) + stazione.temp_min)),
                        borderColor: 'red',
                        backgroundColor: 'rgba(255,0,0,0.2)',
                        fill: true,
                        tension: 0.4
                    },
                    {
                        label: 'Umidità (%)',
                        data: Array.from({length: 24}, () => Math.floor(Math.random() * 30 + 60)),
                        borderColor: 'blue',
                        backgroundColor: 'rgba(0,0,255,0.2)',
                        fill: true,
                        tension: 0.4
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: { y: { beginAtZero: true } }
            }
        });
    }
</script>

</body>
</html>
